## æ¨¡ç³Šæµ‹è¯•(Fuzz Testing)

Forge æ”¯æŒåŸºäºå±æ€§çš„æµ‹è¯•ã€‚

åŸºäºå±æ€§çš„æµ‹è¯•æ˜¯ä¸€ç§æµ‹è¯•ä¸€èˆ¬è¡Œä¸ºè€Œä¸æ˜¯å­¤ç«‹åœºæ™¯çš„æ–¹æ³•ã€‚

è®©æˆ‘ä»¬é€šè¿‡ç¼–å†™å•å…ƒæµ‹è¯•æ¥æ£€æŸ¥è¿™æ„å‘³ç€ä»€ä¹ˆï¼Œæ‰¾åˆ°æˆ‘ä»¬æ­£åœ¨æµ‹è¯•çš„ä¸€èˆ¬å±æ€§ï¼Œå¹¶å°†å…¶è½¬æ¢ä¸ºåŸºäºå±æ€§çš„æµ‹è¯•ï¼š

```solidity
{{#include ../../projects/fuzz_testing/test/Safe.t.sol.1:all}}
```

è¿è¡Œæµ‹è¯•ï¼Œæˆ‘ä»¬çœ‹åˆ°å®ƒé€šè¿‡äº†ï¼š

```sh
{{#include ../output/fuzz_testing/forge-test-no-fuzz:all}}
```

è¿™ä¸ªå•å…ƒæµ‹è¯•_ç¡®å®æµ‹è¯•_æˆ‘ä»¬å¯ä»¥ä»æˆ‘ä»¬çš„ä¿é™©ç®±ï¼ˆSafe åˆçº¦ï¼‰ä¸­å–å‡ºä»¥å¤ªå¸ã€‚ ä½†æ˜¯ï¼Œè°èƒ½è¯´å®ƒé€‚ç”¨äºæ‰€æœ‰é‡‘é¢ï¼Œè€Œä¸ä»…ä»…æ˜¯ 1 ä¸ªä»¥å¤ªå¸ï¼Ÿ

è¿™é‡Œçš„ä¸€èˆ¬æ€§è´¨æ˜¯ï¼šç»™å®šä¸€ä¸ªå®‰å…¨çš„ä½™é¢ï¼Œå½“æˆ‘ä»¬æå–æ—¶ï¼Œæˆ‘ä»¬åº”è¯¥å¾—åˆ°ä¿é™©ç®±é‡Œçš„æ‰€æœ‰çš„èµ„é‡‘ã€‚

Forge å°†è¿è¡Œä»»ä½•è‡³å°‘é‡‡ç”¨ä¸€ä¸ªå‚æ•°çš„æµ‹è¯•ä½œä¸ºåŸºäºå±æ€§çš„æµ‹è¯•ï¼Œæ‰€ä»¥è®©æˆ‘ä»¬é‡å†™ï¼š

```solidity
{{#include ../../projects/fuzz_testing/test/Safe.t.sol.2:contract_prelude}}
    // ...

{{#include ../../projects/fuzz_testing/test/Safe.t.sol.2:test}}
}
```

å¦‚æœæˆ‘ä»¬ç°åœ¨è¿è¡Œæµ‹è¯•ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ° Forge è¿è¡ŒåŸºäºå±æ€§çš„æµ‹è¯•ï¼Œä½†å®ƒå›  amount çš„é«˜å€¼è€Œå¤±è´¥ï¼š

```sh
$ forge test
{{#include ../output/fuzz_testing/forge-test-fail-fuzz:output}}
```

ç»™æµ‹è¯•åˆçº¦çš„é»˜è®¤ä»¥å¤ªå¸æ•°é‡æ˜¯ `2**96 wei`ï¼ˆåœ¨ DappTools ä¸­ï¼‰ï¼Œæ‰€ä»¥æˆ‘ä»¬å¿…é¡»å°† amount ç±»å‹é™åˆ¶ä¸º `uint96` ï¼Œä»¥ç¡®ä¿æˆ‘ä»¬ä¸ä¼šå°è¯•å‘é€è¶…è¿‡`uint96`çš„å€¼ï¼Œ æˆ‘ä»¬ä½¿ç”¨å‚æ•°ï¼š

```solidity
{{#include ../../projects/fuzz_testing/test/Safe.t.sol.3:signature}}
```

ç°åœ¨å®ƒé€šè¿‡äº†ï¼š

```sh
{{#include ../output/fuzz_testing/forge-test-success-fuzz:all}}
```

æ‚¨å¯èƒ½å¸Œæœ›ä½¿ç”¨ [`assume`](../cheatcodes/assume.md) ä½œå¼Šç æ’é™¤æŸäº›æƒ…å†µã€‚ åœ¨è¿™äº›æƒ…å†µä¸‹ï¼Œæ¨¡ç³Šå™¨ fuzzer å°†ä¸¢å¼ƒè¾“å…¥å¹¶å¼€å§‹è¿è¡Œæ–°çš„æ¨¡ç³Šæµ‹è¯•ï¼š

```solidity
function testFuzz_Withdraw(uint96 amount) public {
    vm.assume(amount > 0.1 ether);
    // snip
}
```

æœ‰å¤šç§æ–¹æ³•å¯ä»¥è¿è¡ŒåŸºäºå±æ€§çš„æµ‹è¯•ï¼Œç‰¹åˆ«æ˜¯å‚æ•°æµ‹è¯•å’Œæ¨¡ç³Šæµ‹è¯•ã€‚ Forge ä»…æ”¯æŒæ¨¡ç³Šæµ‹è¯•ã€‚

### è§£è¯»ç»“æœ

æ‚¨å¯èƒ½å·²ç»æ³¨æ„åˆ°ï¼Œä¸å•å…ƒæµ‹è¯•ç›¸æ¯”ï¼Œæ¨¡ç³Šæµ‹è¯•çš„æ€»ç»“ç•¥æœ‰ä¸åŒï¼š

- "runs" æ˜¯æŒ‡æ¨¡ç³Šå™¨ fuzzer æµ‹è¯•çš„åœºæ™¯æ•°é‡ã€‚ é»˜è®¤æƒ…å†µä¸‹ï¼Œæ¨¡ç³Šå™¨ fuzzer å°†ç”Ÿæˆ 256 ä¸ªåœºæ™¯ï¼Œä½†ç”¨æˆ·å¯ä»¥è®¾ç½®æ­¤å‚æ•°ä»¥åŠå…¶ä»–æµ‹è¯•æ‰§è¡Œå‚æ•°ã€‚æœ‰å…³æ¨¡ç³Šæµ‹è¯•å™¨é…ç½®è¯¦ç»†ä¿¡æ¯ï¼Œè¯·å‚é˜… [`è¿™é‡Œ`](#configuring-fuzz-test-execution)ã€‚
- â€œÎ¼â€ï¼ˆå¸Œè…Šå­—æ¯ muï¼‰æ˜¯æ‰€æœ‰æ¨¡ç³Šè¿è¡Œä¸­ä½¿ç”¨çš„å¹³å‡ Gas
- â€œ~â€ï¼ˆæ³¢æµªå·ï¼‰æ˜¯æ‰€æœ‰æ¨¡ç³Šè¿è¡Œä¸­ä½¿ç”¨çš„ä¸­å€¼ Gas

### é…ç½®æ¨¡ç³Šæµ‹è¯•æ‰§è¡Œ

æ¨¡ç³Šæµ‹è¯•æ‰§è¡Œå—ç”¨æˆ·é€šè¿‡ Forge é…ç½®åŸè¯­æ§åˆ¶çš„å‚æ•°çš„çº¦æŸã€‚é…ç½®å¯ä»¥å…¨å±€åº”ç”¨ï¼Œä¹Ÿå¯ä»¥åŸºäºæ¯ä¸ªæµ‹è¯•è¿›è¡Œåº”ç”¨ã€‚æœ‰å…³æ­¤ä¸»é¢˜çš„è¯¦ç»†ä¿¡æ¯ï¼Œè¯·å‚é˜…
 ğŸ“š [`å…¨å±€é…ç½®`](../reference/config/testing.md) å’Œ ğŸ“š [`å†…è”é…ç½®`](../reference/config/inline-test-config.md)ã€‚

 #### æ¨¡ç³Šæµ‹è¯•å›ºå®šè£…ç½®

å½“ä½ æƒ³ç¡®ä¿ä¸€ç»„ç‰¹å®šçš„å€¼è¢«ç”¨ä½œæ¨¡ç³Šå‚æ•°çš„è¾“å…¥æ—¶ï¼Œå¯ä»¥å®šä¹‰æ¨¡ç³Šæµ‹è¯•å›ºå®šè£…ç½®ã€‚
è¿™äº›å›ºå®šè£…ç½®å¯ä»¥åœ¨æµ‹è¯•ä¸­è¢«å£°æ˜ä¸ºï¼š

- ä»¥ `fixture` ä¸ºå‰ç¼€çš„å­˜å‚¨æ•°ç»„ï¼Œåè·Ÿè¦è¿›è¡Œæ¨¡ç³Šå¤„ç†çš„å‚æ•°åç§°ã€‚ä¾‹å¦‚ï¼Œè¦ç”¨äºæ¨¡ç³Šå¤„ç† `uint32` ç±»å‹çš„å‚æ•° `amount` çš„å›ºå®šè£…ç½®å¯ä»¥å®šä¹‰å¦‚ä¸‹ï¼š

```solidity
uint32[] public fixtureAmount = [1, 5, 555];
```

- ä»¥ `fixture` ä¸ºå‰ç¼€å‘½åçš„å‡½æ•°ï¼Œåè·Ÿè¦è¿›è¡Œæ¨¡ç³Šå¤„ç†çš„å‚æ•°åç§°ã€‚å‡½æ•°åº”è¿”å›ä¸€ä¸ªï¼ˆå›ºå®šå¤§å°æˆ–åŠ¨æ€çš„ï¼‰æ•°ç»„ï¼Œä½œä¸ºæ¨¡ç³Šå¤„ç†æ‰€éœ€çš„å€¼ã€‚ä¾‹å¦‚ï¼Œè¦ç”¨äºæ¨¡ç³Šå¤„ç†åç§°ä¸º `owner` çš„ `address` ç±»å‹çš„å‚æ•°çš„å›ºå®šè£…ç½®å¯ä»¥å®šä¹‰ä¸ºå…·æœ‰ä»¥ä¸‹ç­¾åçš„å‡½æ•°ï¼š

```solidity
function fixtureOwner() public returns (address[] memory)
```

å¦‚æœæä¾›çš„å›ºå®šå€¼çš„ç±»å‹ä¸è¦è¿›è¡Œæ¨¡ç³Šå¤„ç†çš„å‘½åå‚æ•°çš„ç±»å‹ä¸ä¸€è‡´ï¼Œåˆ™ä¼šè¢«æ‹’ç»å¹¶å¼•å‘é”™è¯¯ã€‚

ä¸€ä¸ªä½¿ç”¨å›ºå®šè£…ç½®çš„ä¾‹å­æ˜¯å¤ç° `DSChief` æ¼æ´ã€‚è€ƒè™‘ä»¥ä¸‹ä¸¤ä¸ªå‡½æ•°ï¼š

```solidity
    function etch(address yay) public returns (bytes32 slate) {
        bytes32 hash = keccak256(abi.encodePacked(yay));

        slates[hash] = yay;

        return hash;
    }

    function voteSlate(bytes32 slate) public {
        uint weight = deposits[msg.sender];
        subWeight(weight, votes[msg.sender]);
        votes[msg.sender] = slate;
        addWeight(weight, votes[msg.sender]);
    }
```

è¯¥æ¼æ´å¯ä»¥é€šè¿‡åœ¨è°ƒç”¨ `etch` ä¹‹å‰è°ƒç”¨ `voteSlate`ï¼Œä½¿ç”¨ `yay` åœ°å€çš„å“ˆå¸Œå€¼ä½œä¸º `slate` å€¼æ¥é‡ç°ã€‚
ä¸ºäº†ç¡®ä¿æ¨¡ç³Šæµ‹è¯•å™¨åœ¨åŒä¸€è½®è¿è¡Œä¸­åŒ…å«ä» `yay` åœ°å€æ´¾ç”Ÿçš„ `slate` å€¼ï¼Œå¯ä»¥å®šä¹‰ä»¥ä¸‹å›ºå®šè£…ç½®ï¼š

```solidity
    address[] public fixtureYay = [
        makeAddr("yay1"),
        makeAddr("yay2"),
        makeAddr("yay3")
    ];

    bytes32[] public fixtureSlate = [
        keccak256(abi.encodePacked(makeAddr("yay1"))),
        keccak256(abi.encodePacked(makeAddr("yay2"))),
        keccak256(abi.encodePacked(makeAddr("yay3")))
    ];
```

ä»¥ä¸‹å›¾ç‰‡æ˜¾ç¤ºäº†æ¨¡ç³Šæµ‹è¯•å™¨åœ¨å£°æ˜å›ºå®šè£…ç½®å‰åçš„å€¼ç”Ÿæˆæƒ…å†µï¼š
![Fuzzer](../images/fuzzer.png)